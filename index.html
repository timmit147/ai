<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPT Sandbox Chat</title>
<style>
  body { margin:0; font-family: Arial; }
  #sandbox { padding: 20px; background: white; min-height: 100vh; }
  /* Chat button */
  #chatButton {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px; height: 60px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    font-size: 30px;
    border: none;
    cursor: pointer;
    z-index: 999;
  }
  /* Chat panel */
  #chatPanel {
    display: none;
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 300px;
    max-height: 400px;
    background: #f1f1f1;
    border: 1px solid #ccc;
    border-radius: 10px;
    flex-direction: column;
    z-index: 999;
  }
  #messages { flex: 1; overflow-y: auto; padding: 10px; }
  #input { padding: 5px; width: calc(100% - 10px); margin: 5px; box-sizing: border-box; }
  .message.user { text-align: right; color: blue; margin: 2px 0; }
  .message.ai { text-align: left; color: green; margin: 2px 0; }
</style>
</head>
<body>

<div id="sandbox"><h2>Sandbox</h2></div>

<button id="chatButton">ðŸ’¬</button>

<div id="chatPanel">
  <div id="messages"></div>
  <input id="input" type="text" placeholder="Type command..." />
</div>

<script>
let apiKey = prompt("Enter your OpenAI API key:");

const sandbox = document.getElementById('sandbox');
const chatButton = document.getElementById('chatButton');
const chatPanel = document.getElementById('chatPanel');
const input = document.getElementById('input');
const messages = document.getElementById('messages');

chatButton.addEventListener('click', () => {
  chatPanel.style.display = chatPanel.style.display === 'flex' ? 'none' : 'flex';
});

// Add chat messages
function addMessage(from, text) {
  const p = document.createElement('p');
  p.className = 'message ' + from;
  p.textContent = text;
  messages.appendChild(p);
  messages.scrollTop = messages.scrollHeight;
}

// Parse GPT text safely
function applyGPTCommand(text) {
  const lower = text.toLowerCase();
  if (lower.includes('add text')) {
    const match = text.match(/add text[:]? (.+)/i);
    const value = match ? match[1] : 'New Text';
    const p = document.createElement('p');
    p.textContent = value;
    sandbox.appendChild(p);
  } else if (lower.includes('change text color')) {
    const match = text.match(/change text color[:]? (\w+)/i);
    const color = match ? match[1] : 'black';
    Array.from(sandbox.querySelectorAll('p, h1, h2, h3, span')).forEach(el => {
      el.style.color = color;
    });
  } else if (lower.includes('change background')) {
    const match = text.match(/change background[:]? (\w+)/i);
    const color = match ? match[1] : 'white';
    sandbox.style.backgroundColor = color;
  }
}

// Call OpenAI API
async function getGPTResponse(promptText) {
  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "gpt-4",
        messages: [{ role: "user", content: promptText }],
        temperature: 0.7
      })
    });
    const data = await res.json();
    // Check if data.choices exists
    if (data.choices && data.choices[0] && data.choices[0].message) {
      return data.choices[0].message.content;
    } else {
      return "Error: No response from GPT.";
    }
  } catch (err) {
    return "Error: " + err.message;
  }
}

// Handle input
input.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter') {
    const text = input.value;
    input.value = '';
    addMessage('user', text);

    const gptText = await getGPTResponse(text);
    addMessage('ai', gptText);

    applyGPTCommand(gptText);
  }
});
</script>

</body>
</html>
